# Implementation Plan: Secure Session ID Generation and Hashed Storage

**Design Summary:** [README.md](README.md)
**Referenced Patterns:** Inherited from architecture doc
**Related Spec:** N/A

<!-- Gosesh generates session IDs using crypto/rand, hashes them (SHA-256 default, HMAC-SHA256 option)
     before any store interaction. Distinct types (RawSessionID, HashedSessionID) prevent accidental misuse.
     Breaking change to Storer, CredentialSource, and ActivityRecorder interfaces. -->

## Phase Overview

<!-- Each phase is a complete RED-GREEN-REFACTOR cycle in its own file -->
<!-- TDD is MANDATORY: tests must be written first, fail, then pass after implementation -->

| Phase | Description | Depends On | Status |
|-------|-------------|------------|--------|
| [01-core-types-and-generators](phases/01-core-types-and-generators.md) | Add RawSessionID, HashedSessionID types, SessionIDGenerator, SessionIDHasher, default implementations, functional options, and context helpers | None | Complete |
| [02-interface-updates-and-test-infra](phases/02-interface-updates-and-test-infra.md) | Update Storer, CredentialSource, ActivityRecorder interfaces; update fakes, contracts, and test helpers | Phase 01 | Pending |
| [03-store-and-credential-sources](phases/03-store-and-credential-sources.md) | Update MemoryStore, CookieCredentialSource, HeaderCredentialSource, CompositeCredentialSource implementations | Phase 02 | Pending |
| [04-handlers-and-middleware](phases/04-handlers-and-middleware.md) | Update OAuth2Callback, ExchangeExternalToken, Logout, authenticate, AuthenticateAndRefresh, ActivityTracker, and device code handlers | Phase 03 | Pending |

<!-- Status values: Pending | RED | GREEN | Complete -->

## Implementation Notes

<!-- Phase implementers fill in notes/*.md during execution -->
<!-- These capture decisions, issues, and deviations for post-implementation review -->

| Phase | Notes |
|-------|-------|
| Phase 01 | [notes/01-core-types-and-generators.md](notes/01-core-types-and-generators.md) |
| Phase 02 | [notes/02-interface-updates-and-test-infra.md](notes/02-interface-updates-and-test-infra.md) |
| Phase 03 | [notes/03-store-and-credential-sources.md](notes/03-store-and-credential-sources.md) |
| Phase 04 | [notes/04-handlers-and-middleware.md](notes/04-handlers-and-middleware.md) |

## Dependencies

**Dependency Types:**

- **None**: Phase can start immediately
- **Phase NN**: Must wait for specified phase to complete (all gates passed)
- **Parallel**: Multiple phases can execute concurrently

This plan is strictly sequential. Each phase builds on the previous:
- Phase 01 defines the new types that all subsequent phases depend on
- Phase 02 updates interfaces that implementations (Phase 03) and consumers (Phase 04) need
- Phase 03 updates implementations that handlers/middleware (Phase 04) call into
- Phase 04 wires everything together in the handler and middleware layer

## Success Criteria

- All session IDs are generated by gosesh core using `crypto/rand` with 256 bits of entropy
- Raw session IDs are never stored in the backing store; only SHA-256 (or HMAC-SHA256) hashes are persisted
- `RawSessionID` and `HashedSessionID` types prevent accidental misuse at compile time
- `Session.ID()` returns `HashedSessionID` directly (breaking change from `Identifier`)
- Round-trip flow works: generate raw ID -> hash -> store -> read raw from cookie -> hash -> lookup succeeds
- `ExchangeExternalToken` returns the raw session ID (not hashed) in its JSON response
- Device code flow works: `CompleteDeviceCode` stores `RawSessionID`, poll returns it, device uses it as Bearer token, middleware hashes once for lookup
- All existing tests pass (updated for new signatures)
- Custom generator and HMAC hasher options work correctly via functional options
- `MemoryStore.generateSessionID()` is fully removed

All phase gates must pass, plus these overall integration criteria.

## Status

**Progress:** 1/4 phases complete
**Current Phase:** Phase 01 complete, Phase 02 ready
**Blocked:** None

---

_When implementation completes: Delete this entire plan directory (including README.md)._
